#include "/home/juzio/Playground/C++/Kompilator_skrosny/Libs/C/defines.h"
#include "/home/juzio/Playground/C++/Kompilator_skrosny/Libs/C/profiler.h"
#include "/home/juzio/Playground/C++/Kompilator_skrosny/Libs/C/mpctools.h"
#include "/home/juzio/Playground/C++/Kompilator_skrosny/Libs/C/simulated_signals.h"
#include "/home/juzio/Playground/C++/Kompilator_skrosny/Libs/C/default_functions.h"
#include <stdio.h>
#include <stdlib.h>
#include <errno.h>
#include <string.h>
#include <math.h>
#include <sys/time.h>
#include "misc.h"
#include "stm32f4xx_conf.h"
#include "stm32f4xx_it.h"
#include "stm32f4xx.h"

/*STM32 Code*/
typedef enum {LEDG, LEDO, LEDR, LEDB} LED;
typedef enum {BUT1, BUT2, BUT3, BUT4} BUT;
__IO uint32_t TimingDelay = 0;
__IO uint32_t timer = 0;
volatile char str[1000];

void Delay(__IO uint32_t nTime){ TimingDelay = nTime; while(TimingDelay != 0); }
void SysTick_Handler(void){ ++timer; if (TimingDelay != 0x00) --TimingDelay; }

uint32_t led2pin(LED l){
    switch(l){
        case LEDG: return GPIO_Pin_12;
        case LEDO: return GPIO_Pin_13;
        case LEDR: return GPIO_Pin_14;
        case LEDB: return GPIO_Pin_15;
    }
    return GPIO_Pin_12;
}

uint32_t but2pin(BUT l){
    switch(l){
        case BUT1: return GPIO_Pin_1;
        case BUT2: return GPIO_Pin_2;
        case BUT3: return GPIO_Pin_3;
        case BUT4: return GPIO_Pin_4;
    }
    return GPIO_Pin_1;
}

void ledOn(LED l){ GPIO_SetBits(GPIOD, led2pin(l)); }
void ledOff(LED l){ GPIO_ResetBits(GPIOD, led2pin(l)); }
int readButton(BUT b){ return GPIO_ReadInputDataBit(GPIOD, but2pin(b)); }

void USART_puts(USART_TypeDef * usart , volatile char * s){
    while(*s){
        while(!(usart->SR & 0x00000040));
        USART_SendData(usart,*s);
        *s++;
    }
}

void UsartInit(){
    USART_InitTypeDef USART_InitStructure;
    GPIO_InitTypeDef GPIO_InitStructure;

    // USART 6
    RCC_AHB1PeriphClockCmd(RCC_AHB1Periph_GPIOC, ENABLE);
    GPIO_PinAFConfig(GPIOC, GPIO_PinSource6, GPIO_AF_USART6);
    GPIO_InitStructure.GPIO_Pin = GPIO_Pin_6;
    GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AF;
    GPIO_InitStructure.GPIO_OType = GPIO_OType_PP;
    GPIO_InitStructure.GPIO_PuPd = GPIO_PuPd_UP;
    GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;
    GPIO_Init(GPIOC, &GPIO_InitStructure);
    
    RCC_APB2PeriphClockCmd(RCC_APB2Periph_USART6, ENABLE);

    USART_InitStructure.USART_BaudRate = 115200;
    USART_InitStructure.USART_HardwareFlowControl = USART_HardwareFlowControl_None;
    USART_InitStructure.USART_Mode = USART_Mode_Tx;
    USART_InitStructure.USART_Parity = USART_Parity_No;
    USART_InitStructure.USART_StopBits = USART_StopBits_1;
    USART_InitStructure.USART_WordLength = USART_WordLength_8b;
    USART_Init(USART6, &USART_InitStructure);
    USART_Cmd(USART6, ENABLE);

    // USART 2 (TX PA2)
    RCC_AHB1PeriphClockCmd(RCC_AHB1Periph_GPIOA, ENABLE);
    GPIO_PinAFConfig(GPIOA, GPIO_PinSource2, GPIO_AF_USART2);
    GPIO_InitStructure.GPIO_Pin = GPIO_Pin_2;
    GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AF;
    GPIO_InitStructure.GPIO_OType = GPIO_OType_PP;
    GPIO_InitStructure.GPIO_PuPd = GPIO_PuPd_UP;
    GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;
    GPIO_Init(GPIOA, &GPIO_InitStructure);
    
    RCC_APB1PeriphClockCmd(RCC_APB1Periph_USART2, ENABLE);

    USART_InitStructure.USART_BaudRate = 115200;
    USART_InitStructure.USART_HardwareFlowControl = USART_HardwareFlowControl_None;
    USART_InitStructure.USART_Mode = USART_Mode_Tx;
    USART_InitStructure.USART_Parity = USART_Parity_No;
    USART_InitStructure.USART_StopBits = USART_StopBits_1;
    USART_InitStructure.USART_WordLength = USART_WordLength_8b;
    USART_Init(USART2, &USART_InitStructure);
    USART_Cmd(USART2, ENABLE);
}

void ClkInit(){
    SystemCoreClockUpdate();                                // Update system clock (needed to obtain SystemCoreClock)
    SysTick_Config(SystemCoreClock / 1000);                 // Enable SysTick
}

void LedInit(){
    /* Configure the GPIO_LED pin */
    GPIO_InitTypeDef GPIO_InitStructure;
    
    RCC_AHB1PeriphClockCmd(RCC_AHB1Periph_GPIOD, ENABLE);   // Enable the GPIO_LED Clock
    GPIO_InitStructure.GPIO_Pin   = GPIO_Pin_12 | GPIO_Pin_13 | GPIO_Pin_14 | GPIO_Pin_15;
    GPIO_InitStructure.GPIO_Mode  = GPIO_Mode_OUT;
    GPIO_InitStructure.GPIO_OType = GPIO_OType_PP;
    GPIO_InitStructure.GPIO_PuPd  = GPIO_PuPd_UP;
    GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;
    GPIO_Init(GPIOD, &GPIO_InitStructure);
    ledOff(LEDO);
    ledOff(LEDR);
    ledOff(LEDG);
    ledOff(LEDB);
}

void AdcInit(){ // ADC1_IN14 on PC4
    ADC_InitTypeDef ADC_InitStructure;
    ADC_CommonInitTypeDef ADC_CommonInitStructure;
    GPIO_InitTypeDef GPIO_InitStructure;

    RCC_APB2PeriphClockCmd(RCC_APB2Periph_ADC1, ENABLE);
    RCC_AHB1PeriphClockCmd(RCC_AHB1Periph_GPIOC, ENABLE);
    GPIO_InitStructure.GPIO_Pin = GPIO_Pin_4;
    GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AN;
    GPIO_InitStructure.GPIO_PuPd = GPIO_PuPd_NOPULL;
    GPIO_Init(GPIOC, &GPIO_InitStructure);

    ADC_DeInit();

    ADC_CommonInitStructure.ADC_Mode = ADC_Mode_Independent;
    ADC_CommonInitStructure.ADC_Prescaler = ADC_Prescaler_Div2;
    ADC_CommonInitStructure.ADC_DMAAccessMode = ADC_DMAAccessMode_Disabled;
    ADC_CommonInit(&ADC_CommonInitStructure);

    ADC_InitStructure.ADC_Resolution = ADC_Resolution_12b;
    ADC_InitStructure.ADC_ScanConvMode = DISABLE;
    ADC_InitStructure.ADC_ContinuousConvMode = DISABLE;
    ADC_InitStructure.ADC_ExternalTrigConvEdge = ADC_ExternalTrigConvEdge_None;
    ADC_InitStructure.ADC_ExternalTrigConv = 0;
    ADC_InitStructure.ADC_DataAlign = ADC_DataAlign_Right;
    ADC_InitStructure.ADC_NbrOfConversion = 1;
    ADC_Init(ADC1, &ADC_InitStructure);

    ADC_RegularChannelConfig(ADC1, ADC_Channel_14, 1, ADC_SampleTime_28Cycles);

    ADC_Cmd(ADC1, ENABLE);
}

void ButtonsInit(){
    GPIO_InitTypeDef GPIO_InitStructure;
    RCC_AHB1PeriphClockCmd(RCC_AHB1Periph_GPIOD, ENABLE);
    GPIO_InitStructure.GPIO_Pin = GPIO_Pin_1|GPIO_Pin_2|GPIO_Pin_3|GPIO_Pin_4|GPIO_Pin_5|GPIO_Pin_6;
    GPIO_InitStructure.GPIO_Mode = GPIO_Mode_IN;
    GPIO_InitStructure.GPIO_OType = GPIO_OType_PP;
    GPIO_InitStructure.GPIO_PuPd = GPIO_PuPd_DOWN;
    GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;
    GPIO_Init(GPIOD, &GPIO_InitStructure);
}

void TIM3_IRQHandler(void){
    if (TIM_GetITStatus(TIM3, TIM_IT_Update) != RESET) {
        TIM_ClearITPendingBit(TIM3, TIM_IT_Update);
        timer_loop();
    }
}

void TimerInit(void){
    TIM_TimeBaseInitTypeDef TIM_TimeBaseStructure;
    NVIC_InitTypeDef NVIC_InitStructure;

    /* TIM3 clock enable */
    RCC_APB1PeriphClockCmd(RCC_APB1Periph_TIM3, ENABLE);

    /* Enable the TIM3 gloabal Interrupt */
    NVIC_InitStructure.NVIC_IRQChannel = TIM3_IRQn;
    NVIC_InitStructure.NVIC_IRQChannelPreemptionPriority = 2;
    NVIC_InitStructure.NVIC_IRQChannelSubPriority = 2;
    NVIC_InitStructure.NVIC_IRQChannelCmd = ENABLE;
    NVIC_Init(&NVIC_InitStructure);
    // NVIC_SetPriorityGrouping(2);
    NVIC_SetPriority(TIM3_IRQn, 1);
 
    // PrescalerValue = (uint16_t) ((SystemCoreClock / 2) / 65536) - 1;
    TIM_TimeBaseStructure.TIM_Period = 2000 - 1;
    TIM_TimeBaseStructure.TIM_Prescaler = 2100 - 1;
    TIM_TimeBaseStructure.TIM_ClockDivision = 0;
    TIM_TimeBaseStructure.TIM_CounterMode = TIM_CounterMode_Up;
    TIM_TimeBaseInit(TIM3, &TIM_TimeBaseStructure);
    /* TIM Interrupts enable */
    TIM_ITConfig(TIM3, TIM_IT_Update, ENABLE);
    /* TIM3 enable counter */
    TIM_Cmd(TIM3, ENABLE);    
}

void FpuInit(void){
    SCB->CPACR |= ((3UL << 10*2)|(3UL << 11*2));  /* set CP10 and CP11 Full Access */
}

char * float2str(float x){
    char tmpstr[100];
    int integer = (int)(x);
    int fractional = (int)( (x-integer)*10000 );
    if(fractional < 0) fractional *= -1;
    sprintf(tmpstr, "%d.%04d",integer, fractional);
    return tmpstr;
}

void send_control_signal(float u){
    sprintf(str,"!%04d",(int)(last_control(&ad)*100));
    USART_puts(USART2, str);
}

void hardware_setup(){
profiler_start(2);
    ClkInit();
    FpuInit();
    LedInit();  
    ButtonsInit();
    UsartInit();
    AdcInit();
    TimerInit();
profiler_end(2);
}

void measurements(){
profiler_start(0);
    uint32_t pomiar = 0;
    ADC_SoftwareStartConv(ADC1);
    while(ADC_GetFlagStatus(ADC1, ADC_FLAG_EOC) == RESET);
    pomiar = (uint16_t)ADC_GetConversionValue(ADC1);
    new_output(&ad,pomiar*0.01);
profiler_end(0);
}

void write_string_ext(char * s, int clean, int newline){
    USART_puts(USART6, s);
    if(newline) USART_puts(USART6, "\n");
    if(clean)   memset(s, 0, strlen(s));
}
void write_string(char * s){
    write_string_ext(s,1,1);
}

long get_time(){
    return timer;
}

//////////////////////////////////////////////////// TUTAJ ZACZYNA SIE ROBOTA SPECJALISTY MATLAB
void PID(ArchiveData * ad, CurrentControl * c){
	static float e0;
	static float e1;
	static float e2;
	if(ad == NULL) return;
	e0 = ad->yzad - ad->yk[M( 0)];
	e1 = ad->yzad - ad->yk[M(-1)];
	e2 = ad->yzad - ad->yk[M(-2)];
	setCurrentControlIncrement(c,4.950000*e0 + -4.050000*e1 + 0.000000*e2); // algorytm przyrostowy
}

void DMC_analitic(ArchiveData * ad, CurrentControl * c){
	static long i,j,k;
	static float du;
	static float dUp[49] = {0};
	static float Y[10] = {0};
	static float Y0[10] = {0};
	static float K1[10] = {0.000000000000000e+00,1.078013221252010e+01,2.704050368824085e-02,3.456830008155976e-02,4.401223145345045e-01,-5.392134275091448e-01,1.175429159691136e-02,3.984603045016264e-01,-3.210642215170273e-01,-1.240308895145838e-01};
	static float Mp[10][49] = {{9.215000000000000e-02,8.170000000000001e-02,7.424999999999998e-02,7.069999999999999e-02,5.900000000000005e-02,5.324999999999996e-02,5.120000000000002e-02,4.309999999999997e-02,3.754999999999997e-02,3.845000000000010e-02,3.084999999999993e-02,3.015000000000001e-02,2.539999999999998e-02,2.029999999999998e-02,2.245000000000008e-02,1.964999999999995e-02,1.750000000000007e-02,1.389999999999991e-02,1.475000000000004e-02,1.175000000000004e-02,1.039999999999996e-02,8.549999999999947e-03,1.150000000000007e-02,6.699999999999928e-03,7.500000000000062e-03,5.399999999999960e-03,6.249999999999978e-03,5.850000000000022e-03,3.149999999999986e-03,5.900000000000016e-03,2.800000000000025e-03,4.449999999999954e-03,1.850000000000018e-03,3.249999999999975e-03,2.850000000000019e-03,2.199999999999980e-03,1.850000000000018e-03,1.000000000000001e-03,3.850000000000020e-03,8.500000000000174e-04,-1.000000000000001e-03,1.850000000000018e-03,1.599999999999935e-03,3.500000000000725e-04,7.499999999999174e-04,-1.999999999999780e-04,1.300000000000079e-03,1.699999999999924e-03,-1.499999999999835e-04},{1.738500000000000e-01,1.559500000000000e-01,1.449500000000000e-01,1.297000000000000e-01,1.122500000000000e-01,1.044500000000000e-01,9.429999999999999e-02,8.064999999999994e-02,7.600000000000007e-02,6.930000000000003e-02,6.099999999999994e-02,5.554999999999999e-02,4.569999999999996e-02,4.275000000000007e-02,4.210000000000003e-02,3.715000000000002e-02,3.139999999999998e-02,2.864999999999995e-02,2.650000000000008e-02,2.215000000000000e-02,1.894999999999991e-02,2.005000000000001e-02,1.819999999999999e-02,1.419999999999999e-02,1.290000000000002e-02,1.164999999999994e-02,1.210000000000000e-02,9.000000000000008e-03,9.050000000000002e-03,8.700000000000041e-03,7.249999999999979e-03,6.299999999999972e-03,5.099999999999993e-03,6.099999999999994e-03,5.049999999999999e-03,4.049999999999998e-03,2.850000000000019e-03,4.850000000000021e-03,4.700000000000037e-03,-1.499999999999835e-04,8.500000000000174e-04,3.449999999999953e-03,1.950000000000007e-03,1.099999999999990e-03,5.499999999999394e-04,1.100000000000101e-03,3.000000000000003e-03,1.549999999999940e-03,-1.499999999999835e-04},{2.481000000000000e-01,2.266500000000000e-01,2.039500000000000e-01,1.829500000000000e-01,1.634500000000000e-01,1.475500000000000e-01,1.318500000000000e-01,1.191000000000000e-01,1.068500000000000e-01,9.945000000000004e-02,8.639999999999992e-02,7.584999999999997e-02,6.815000000000004e-02,6.240000000000001e-02,5.960000000000010e-02,5.104999999999993e-02,4.615000000000002e-02,4.039999999999999e-02,3.690000000000004e-02,3.069999999999995e-02,3.044999999999998e-02,2.674999999999994e-02,2.570000000000006e-02,1.959999999999995e-02,1.915000000000000e-02,1.749999999999996e-02,1.524999999999999e-02,1.490000000000002e-02,1.185000000000003e-02,1.315000000000000e-02,9.099999999999997e-03,9.549999999999947e-03,7.950000000000013e-03,8.299999999999974e-03,6.900000000000017e-03,5.049999999999999e-03,6.700000000000039e-03,5.700000000000038e-03,3.700000000000037e-03,1.700000000000035e-03,2.449999999999952e-03,3.800000000000026e-03,2.699999999999925e-03,9.000000000000119e-04,1.850000000000018e-03,2.800000000000025e-03,2.850000000000019e-03,1.549999999999940e-03,-1.499999999999835e-04},{3.188000000000000e-01,2.856500000000000e-01,2.572000000000000e-01,2.341500000000000e-01,2.065500000000000e-01,1.850999999999999e-01,1.703000000000001e-01,1.499500000000000e-01,1.370000000000000e-01,1.248500000000000e-01,1.066999999999999e-01,9.830000000000005e-02,8.779999999999999e-02,7.990000000000008e-02,7.350000000000001e-02,6.579999999999997e-02,5.790000000000006e-02,5.079999999999996e-02,4.544999999999999e-02,4.220000000000002e-02,3.714999999999991e-02,3.425000000000000e-02,3.110000000000002e-02,2.584999999999993e-02,2.500000000000002e-02,2.064999999999995e-02,2.115000000000000e-02,1.770000000000005e-02,1.629999999999998e-02,1.500000000000001e-02,1.234999999999997e-02,1.239999999999997e-02,1.014999999999999e-02,1.014999999999999e-02,7.900000000000018e-03,8.900000000000019e-03,7.550000000000057e-03,4.700000000000037e-03,5.550000000000055e-03,3.299999999999970e-03,2.800000000000025e-03,4.549999999999943e-03,2.499999999999947e-03,2.200000000000091e-03,3.549999999999942e-03,2.650000000000041e-03,2.850000000000019e-03,1.549999999999940e-03,-1.499999999999835e-04},{3.778000000000000e-01,3.389000000000000e-01,3.084000000000000e-01,2.772500000000000e-01,2.441000000000000e-01,2.235500000000000e-01,2.011500000000000e-01,1.801000000000000e-01,1.624000000000000e-01,1.451500000000000e-01,1.291500000000000e-01,1.179500000000000e-01,1.053000000000001e-01,9.379999999999999e-02,8.825000000000005e-02,7.755000000000001e-02,6.830000000000003e-02,5.934999999999990e-02,5.695000000000006e-02,4.889999999999994e-02,4.464999999999997e-02,3.964999999999996e-02,3.734999999999999e-02,3.169999999999995e-02,2.815000000000001e-02,2.654999999999996e-02,2.395000000000003e-02,2.215000000000000e-02,1.815000000000000e-02,1.824999999999999e-02,1.519999999999999e-02,1.459999999999995e-02,1.200000000000001e-02,1.114999999999999e-02,1.175000000000004e-02,9.750000000000036e-03,6.550000000000056e-03,6.550000000000056e-03,7.149999999999990e-03,3.650000000000042e-03,3.549999999999942e-03,4.349999999999965e-03,3.800000000000026e-03,3.900000000000015e-03,3.399999999999959e-03,2.650000000000041e-03,2.850000000000019e-03,1.549999999999940e-03,-1.499999999999835e-04},{4.310500000000000e-01,3.901000000000000e-01,3.515000000000000e-01,3.148000000000000e-01,2.825500000000001e-01,2.544000000000000e-01,2.313000000000000e-01,2.055000000000000e-01,1.827000000000000e-01,1.676000000000001e-01,1.487999999999999e-01,1.354500000000001e-01,1.192000000000000e-01,1.085500000000000e-01,1.000000000000001e-01,8.794999999999997e-02,7.684999999999997e-02,7.084999999999997e-02,6.364999999999998e-02,5.640000000000001e-02,5.004999999999993e-02,4.589999999999994e-02,4.320000000000002e-02,3.484999999999994e-02,3.405000000000002e-02,2.934999999999999e-02,2.839999999999998e-02,2.400000000000002e-02,2.139999999999997e-02,2.110000000000001e-02,1.739999999999997e-02,1.644999999999996e-02,1.300000000000001e-02,1.500000000000001e-02,1.260000000000006e-02,8.750000000000036e-03,8.400000000000074e-03,8.149999999999991e-03,7.500000000000062e-03,4.399999999999959e-03,3.349999999999964e-03,5.650000000000044e-03,5.499999999999949e-03,3.750000000000031e-03,3.399999999999959e-03,2.650000000000041e-03,2.850000000000019e-03,1.549999999999940e-03,-1.499999999999835e-04},{4.822500000000000e-01,4.332000000000000e-01,3.890500000000000e-01,3.532500000000001e-01,3.134000000000000e-01,2.845500000000000e-01,2.567000000000000e-01,2.257999999999999e-01,2.051500000000001e-01,1.872500000000000e-01,1.663000000000000e-01,1.493500000000000e-01,1.339500000000000e-01,1.203000000000001e-01,1.104000000000001e-01,9.649999999999992e-02,8.835000000000004e-02,7.754999999999990e-02,7.115000000000005e-02,6.179999999999997e-02,5.629999999999991e-02,5.174999999999996e-02,4.635000000000000e-02,4.074999999999995e-02,3.685000000000005e-02,3.379999999999994e-02,3.025000000000000e-02,2.725000000000000e-02,2.424999999999999e-02,2.329999999999999e-02,1.924999999999999e-02,1.744999999999997e-02,1.685000000000003e-02,1.585000000000003e-02,1.160000000000005e-02,1.060000000000005e-02,1.000000000000001e-02,8.500000000000063e-03,8.249999999999980e-03,4.199999999999982e-03,4.650000000000043e-03,7.349999999999968e-03,5.349999999999966e-03,3.750000000000031e-03,3.399999999999959e-03,2.650000000000041e-03,2.850000000000019e-03,1.549999999999940e-03,-1.499999999999835e-04},{5.253500000000000e-01,4.707499999999999e-01,4.275000000000000e-01,3.841000000000000e-01,3.435500000000000e-01,3.099499999999999e-01,2.770000000000000e-01,2.482500000000000e-01,2.248000000000000e-01,2.047500000000001e-01,1.801999999999999e-01,1.641000000000000e-01,1.457000000000001e-01,1.307000000000000e-01,1.189500000000000e-01,1.080000000000000e-01,9.504999999999997e-02,8.504999999999996e-02,7.655000000000001e-02,6.804999999999994e-02,6.214999999999993e-02,5.489999999999995e-02,5.225000000000002e-02,4.354999999999998e-02,4.130000000000000e-02,3.564999999999996e-02,3.349999999999997e-02,3.010000000000002e-02,2.644999999999997e-02,2.515000000000001e-02,2.024999999999999e-02,2.129999999999999e-02,1.770000000000005e-02,1.485000000000003e-02,1.345000000000007e-02,1.219999999999999e-02,1.035000000000008e-02,9.249999999999980e-03,8.050000000000002e-03,5.500000000000060e-03,6.349999999999967e-03,7.199999999999984e-03,5.349999999999966e-03,3.750000000000031e-03,3.399999999999959e-03,2.650000000000041e-03,2.850000000000019e-03,1.549999999999940e-03,-1.499999999999835e-04},{5.629000000000000e-01,5.092000000000001e-01,4.583500000000000e-01,4.142500000000000e-01,3.689500000000000e-01,3.302499999999999e-01,2.994500000000000e-01,2.679000000000000e-01,2.423000000000001e-01,2.186500000000000e-01,1.949500000000000e-01,1.758500000000001e-01,1.561000000000000e-01,1.392500000000000e-01,1.304500000000001e-01,1.146999999999999e-01,1.025500000000000e-01,9.044999999999992e-02,8.279999999999998e-02,7.389999999999997e-02,6.529999999999991e-02,6.079999999999997e-02,5.505000000000004e-02,4.799999999999993e-02,4.315000000000002e-02,3.889999999999993e-02,3.634999999999999e-02,3.230000000000000e-02,2.829999999999999e-02,2.615000000000001e-02,2.410000000000001e-02,2.215000000000000e-02,1.670000000000005e-02,1.670000000000005e-02,1.505000000000001e-02,1.255000000000006e-02,1.110000000000000e-02,9.050000000000002e-03,9.350000000000080e-03,7.199999999999984e-03,6.199999999999983e-03,7.199999999999984e-03,5.349999999999966e-03,3.750000000000031e-03,3.399999999999959e-03,2.650000000000041e-03,2.850000000000019e-03,1.549999999999940e-03,-1.499999999999835e-04},{6.013500000000001e-01,5.400500000000000e-01,4.885000000000000e-01,4.396500000000000e-01,3.892500000000000e-01,3.527000000000000e-01,3.191000000000000e-01,2.854000000000000e-01,2.562000000000000e-01,2.334000000000001e-01,2.067000000000000e-01,1.862500000000000e-01,1.646500000000000e-01,1.507500000000001e-01,1.371500000000000e-01,1.222000000000000e-01,1.079500000000000e-01,9.669999999999990e-02,8.865000000000001e-02,7.704999999999995e-02,7.119999999999993e-02,6.359999999999999e-02,5.950000000000000e-02,4.984999999999995e-02,4.640000000000000e-02,4.174999999999995e-02,3.854999999999997e-02,3.415000000000001e-02,2.929999999999999e-02,3.000000000000003e-02,2.495000000000003e-02,2.115000000000000e-02,1.855000000000007e-02,1.829999999999998e-02,1.540000000000008e-02,1.329999999999998e-02,1.090000000000002e-02,1.035000000000008e-02,1.105000000000000e-02,7.050000000000001e-03,6.199999999999983e-03,7.199999999999984e-03,5.349999999999966e-03,3.750000000000031e-03,3.399999999999959e-03,2.650000000000041e-03,2.850000000000019e-03,1.549999999999940e-03,-1.499999999999835e-04}};
	if(ad == NULL) return;
	du=0;
	for(i=1; i<=49; ++i) dUp[M(i)] = ad->duk1[M(-i)]; 
	for(i=1; i<=10; ++i) Y[M(i)] = ad->yk[M(0)];
	for(i=1; i<=10; ++i){
		float tmp = 0;
		for(j=1; j<=49; ++j){
			tmp += Mp[M(i)][M(j)]*dUp[M(j)];
		}
		Y0[M(i)] = Y[M(i)]+tmp;
	}
	for(i=1; i<=10; ++i) du += K1[M(i)]*(ad->yzad-Y0[M(i)]);
	setCurrentControlIncrement(c,du);
}


//////////////////////////////////////////////////// TUTAJ ZACZYNA SIE ROBOTA UZYTKOWNIKA KONCOWEGO
enum {ALG_PID, ALG_DMC_ANALITIC};
volatile int algorithm = ALG_PID;

ArchiveData ad;
CurrentControl cc;


void controller_setup(){
profiler_start(1);
    init_archive_data(&ad, 200, 200, 0, 0, 10.0);
    get_time();
    PID(NULL,NULL);
    DMC_analitic(NULL,NULL);
profiler_end(1);
}

void idle(){
    if(readButton(BUT1)) algorithm = ALG_PID;
    else                 algorithm = ALG_DMC_ANALITIC;

    if(readButton(BUT2)) ad.yzad = 30.0;
    else                 ad.yzad = 10.0;

    if(readButton(BUT3)) while(1);
    
    // Komunikacja z komputerem zbierającym dane 
    sprintf(str, "%d,%s,"  , algorithm,float2str(ad.yk[M(0)]));
    write_string_ext(str, 1, 0);
    sprintf(str,       "%s,", float2str(ad.yzad));
    write_string_ext(str, 1, 0);
    sprintf(str,            "%s", float2str(ad.uk1[M(-1)]));
    write_string(str);
}

void loop(){
    if(algorithm == ALG_PID){
profiler_start(10);
        PID(&ad,&cc);
profiler_end(10);
    }
    if(algorithm == ALG_DMC_ANALITIC) {
profiler_start(11);
        DMC_analitic(&ad,&cc);
profiler_end(11);
    }
}

void controls(){
profiler_start(4);
    pushCurrentControlsToArchiveData(&cc,&ad);
    projectOnFeasibleSet(&ad, -10.0,10.0, 0.0, 40.0);
    send_control_signal(last_control(&ad));
profiler_end(4);
}

void timeout(){
    // Zapal diode czerwona
    ledOn(LEDR);
    // Wystaw zerowe sterowanie
    send_control_signal(0);
    // Wyswietl wyniki dzialania profilera
    print_profiler();
    // Wejdz w petle nieskonczona
    while(1);
}

