#include "D:\Git\GitHub\Cpp\Kompilator_skrosny\Libs\C\defines.h"
#include "D:\Git\GitHub\Cpp\Kompilator_skrosny\Libs\C\mpctools.h"
#include "D:\Git\GitHub\Cpp\Kompilator_skrosny\Libs\C\simulated_signals.h"
#include "D:\Git\GitHub\Cpp\Kompilator_skrosny\Libs\C\default_functions.h"
#include <string.h>
#include "low_lvl_main.h"
#include "obl_macierzowe.h"
#include "mat_lib.h"
#include "alokacja_nr.h"
#include "pk.h"

#define __FUN_WRITE() {write_string((char*)__func__);write_string((char*)"\r\n");}while(0)

char str[100];

extern void timer_loop(void);

long get_time(){
    // TODO
    return 0;
}

float* measureOutput(){
    return __measureOutput(); // values from -1 to 1
}

void setControlValue(float* value){ // values from -1 to 1
    __setControlValue(value);
}

void hardware_setup(){
    printf("\033[33m TEST\n");
}

void printMat2(float ** A, long x, long y, const char * fmat){
    long i = 1;
    long j = 1;
    for(i=1; i<=x; ++i){
        if(i==1) write_string("[");
        else     write_string(" ");
        for(j=1; j<=y; ++j){
            sprintf(str,fmat,A[i][j]);
            write_string(str);
            if(j==y && i!=x) write_string(";\n\r");
            if(j!=y) write_string(",");
        }
        if(i==x) write_string("]\n\r");
    }
}

void printVec2(float * A, long x, const char * fmat){
    long i = 1;
    write_string("[");
    for(i=1; i<=x; ++i){
        if(i!=1) write_string(" ");
        sprintf(str,fmat,A[i]);
        write_string(str);
        if(i!=x) write_string(";\n\r");
    }
    write_string("]\n\r");
}
//////////////////////////////////////////////////// TUTAJ ZACZYNA SIE ROBOTA SPECJALISTY MATLAB
void CONTROLLER(ArchiveData * ad, CurrentControl * c){
	static float Ke[4] = {-9.155198300527818e-01f,+3.588531841308317e+00f,
	                      +1.112659703657048e+00f,+1.568678272726415e-01f};
	static float Ku[16] = {+4.075047913791416e-01f,+1.350118013194716e-01f,+3.373224928901025e-01f,+1.412099000961214e-01f,+2.457501252899684e-01f,+1.320691032681125e-01f,+1.320324153956440e-01f,+9.217838418492078e-02f,
	                       +6.197303801109064e-02f,+7.662851260655799e-01f,+6.506386875505972e-02f,+6.895746578422654e-01f,+6.348604667613500e-02f,+5.776872069305191e-01f,+4.651045086805199e-02f,+3.716733360343136e-01f};

	static long m,i,p,n;
	static float du[2];
	static float Ydiff[2]= {0.0f};
	static float dUp[8]= {0.0f};
	static float dutmp[2] = {0.0f};
	const long k = 0;
	if(ad == NULL) return;
	for(m=0;m<2;++m){
		Ydiff[m] = ad->z[m]-ad->y[k][m];
	}
	i=0;
	for(p=0;p<4;++p){
		for(n=0;n<2;++n){
			dUp[i] = ad->u[k-p-1][n] - ad->u[k-p-2][n];
			++i;
		}
	}
	mat_mul(Ke,2,2, Ydiff,2,1, du);
	mat_mul(Ku,2,8, dUp,8,1, dutmp);
	for(n=0;n<2;++n){
		if(ad->u[k-1][n]+du[n] > +1.000000000000000e+00f) du[n] = +1.000000000000000e+00f-ad->u[k-1][n];
		if(ad->u[k-1][n]+du[n] < -1.000000000000000e+00f) du[n] = -1.000000000000000e+00f-ad->u[k-1][n];
	}
	setCurrentControlIncrement(c,du);
}
void CONTROLLER_N(ArchiveData * ad, CurrentControl * c){
	static long m,i,j,p,n,l;
	static float du[2];
	static float **reg_M,**reg_MP,**reg_PSI,**reg_LAMBDA;
	static float *reg_DUP,*reg_Yzad,*reg_Yk,*reg_Y0;
	static float **pk_A,**pk_G,*pk_b,*pk_t,*pk_x,*reg_wp1,**reg_mp1;
	const long k = 0;
	if(ad == NULL){
		reg_M=dtablica(1,20,1,10);
		reg_MP=dtablica(1,20,1,8);
		reg_PSI=dtablica(1,20,1,20);
		reg_LAMBDA=dtablica(1,10,1,10);
		reg_M[1][1] = +4.195175567360300e-02f;		reg_M[1][2] = +4.758129098202020e-01f;		reg_M[1][3] = +0.000000000000000e+00f;		reg_M[1][4] = +0.000000000000000e+00f;		reg_M[1][5] = +0.000000000000000e+00f;		reg_M[1][6] = +0.000000000000000e+00f;		reg_M[1][7] = +0.000000000000000e+00f;		reg_M[1][8] = +0.000000000000000e+00f;		reg_M[1][9] = +0.000000000000000e+00f;		reg_M[1][10] = +0.000000000000000e+00f;		reg_M[2][1] = +5.823546641575100e-02f;		reg_M[2][2] = +1.445130273428940e-01f;		reg_M[2][3] = +0.000000000000000e+00f;		reg_M[2][4] = +0.000000000000000e+00f;		reg_M[2][5] = +0.000000000000000e+00f;		reg_M[2][6] = +0.000000000000000e+00f;		reg_M[2][7] = +0.000000000000000e+00f;		reg_M[2][8] = +0.000000000000000e+00f;		reg_M[2][9] = +0.000000000000000e+00f;		reg_M[2][10] = +0.000000000000000e+00f;		reg_M[3][1] = +8.214356154310699e-02f;		reg_M[3][2] = +9.063462346100910e-01f;		reg_M[3][3] = +4.195175567360300e-02f;		reg_M[3][4] = +4.758129098202020e-01f;		reg_M[3][5] = +0.000000000000000e+00f;		reg_M[3][6] = +0.000000000000000e+00f;		reg_M[3][7] = +0.000000000000000e+00f;		reg_M[3][8] = +0.000000000000000e+00f;		reg_M[3][9] = +0.000000000000000e+00f;		reg_M[3][10] = +0.000000000000000e+00f;		reg_M[4][1] = +1.130795632828420e-01f;		reg_M[4][2] = +2.785840471498840e-01f;		reg_M[4][3] = +5.823546641575100e-02f;		reg_M[4][4] = +1.445130273428940e-01f;		reg_M[4][5] = +0.000000000000000e+00f;		reg_M[4][6] = +0.000000000000000e+00f;		reg_M[4][7] = +0.000000000000000e+00f;		reg_M[4][8] = +0.000000000000000e+00f;		reg_M[4][9] = +0.000000000000000e+00f;		reg_M[4][10] = +0.000000000000000e+00f;		reg_M[5][1] = +1.206492505926940e-01f;		reg_M[5][2] = +1.295908896591411e+00f;		reg_M[5][3] = +8.214356154310699e-02f;		reg_M[5][4] = +9.063462346100910e-01f;		reg_M[5][5] = +4.195175567360300e-02f;		reg_M[5][6] = +4.758129098202020e-01f;		reg_M[5][7] = +0.000000000000000e+00f;		reg_M[5][8] = +0.000000000000000e+00f;		reg_M[5][9] = +0.000000000000000e+00f;		reg_M[5][10] = +0.000000000000000e+00f;		reg_M[6][1] = +1.647297885887280e-01f;		reg_M[6][2] = +4.029675624812460e-01f;		reg_M[6][3] = +1.130795632828420e-01f;		reg_M[6][4] = +2.785840471498840e-01f;		reg_M[6][5] = +5.823546641575100e-02f;		reg_M[6][6] = +1.445130273428940e-01f;		reg_M[6][7] = +0.000000000000000e+00f;		reg_M[6][8] = +0.000000000000000e+00f;		reg_M[6][9] = +0.000000000000000e+00f;		reg_M[6][10] = +0.000000000000000e+00f;		reg_M[7][1] = +1.575395583832290e-01f;		reg_M[7][2] = +1.648399769821804e+00f;		reg_M[7][3] = +1.206492505926940e-01f;		reg_M[7][4] = +1.295908896591411e+00f;		reg_M[7][5] = +8.214356154310699e-02f;		reg_M[7][6] = +9.063462346100910e-01f;		reg_M[7][7] = +4.195175567360300e-02f;		reg_M[7][8] = +4.758129098202020e-01f;		reg_M[7][9] = +0.000000000000000e+00f;		reg_M[7][10] = +0.000000000000000e+00f;		reg_M[8][1] = +2.133721389334470e-01f;		reg_M[8][2] = +5.183635586365640e-01f;		reg_M[8][3] = +1.647297885887280e-01f;		reg_M[8][4] = +4.029675624812460e-01f;		reg_M[8][5] = +1.130795632828420e-01f;		reg_M[8][6] = +2.785840471498840e-01f;		reg_M[8][7] = +5.823546641575100e-02f;		reg_M[8][8] = +1.445130273428940e-01f;		reg_M[8][9] = +0.000000000000000e+00f;		reg_M[8][10] = +0.000000000000000e+00f;		reg_M[9][1] = +1.928822529946110e-01f;		reg_M[9][2] = +1.967346701436834e+00f;		reg_M[9][3] = +1.575395583832290e-01f;		reg_M[9][4] = +1.648399769821804e+00f;		reg_M[9][5] = +1.206492505926940e-01f;		reg_M[9][6] = +1.295908896591411e+00f;		reg_M[9][7] = +8.214356154310699e-02f;		reg_M[9][8] = +9.063462346100910e-01f;		reg_M[9][9] = +4.195175567360300e-02f;		reg_M[9][10] = +4.758129098202020e-01f;		reg_M[10][1] = +2.591817793182820e-01f;		reg_M[10][2] = +6.254214424180560e-01f;		reg_M[10][3] = +2.133721389334470e-01f;		reg_M[10][4] = +5.183635586365640e-01f;		reg_M[10][5] = +1.647297885887280e-01f;		reg_M[10][6] = +4.029675624812460e-01f;		reg_M[10][7] = +1.130795632828420e-01f;		reg_M[10][8] = +2.785840471498840e-01f;		reg_M[10][9] = +5.823546641575100e-02f;		reg_M[10][10] = +1.445130273428940e-01f;		reg_M[11][1] = +1.928822529946110e-01f;		reg_M[11][2] = +1.967346701436834e+00f;		reg_M[11][3] = +1.928822529946110e-01f;		reg_M[11][4] = +1.967346701436834e+00f;		reg_M[11][5] = +1.575395583832290e-01f;		reg_M[11][6] = +1.648399769821804e+00f;		reg_M[11][7] = +1.206492505926940e-01f;		reg_M[11][8] = +1.295908896591411e+00f;		reg_M[11][9] = +8.214356154310699e-02f;		reg_M[11][10] = +9.063462346100910e-01f;		reg_M[12][1] = +2.591817793182820e-01f;		reg_M[12][2] = +6.254214424180560e-01f;		reg_M[12][3] = +2.591817793182820e-01f;		reg_M[12][4] = +6.254214424180560e-01f;		reg_M[12][5] = +2.133721389334470e-01f;		reg_M[12][6] = +5.183635586365640e-01f;		reg_M[12][7] = +1.647297885887280e-01f;		reg_M[12][8] = +4.029675624812460e-01f;		reg_M[12][9] = +1.130795632828420e-01f;		reg_M[12][10] = +2.785840471498840e-01f;		reg_M[13][1] = +1.928822529946110e-01f;		reg_M[13][2] = +1.967346701436834e+00f;		reg_M[13][3] = +1.928822529946110e-01f;		reg_M[13][4] = +1.967346701436834e+00f;		reg_M[13][5] = +1.928822529946110e-01f;		reg_M[13][6] = +1.967346701436834e+00f;		reg_M[13][7] = +1.575395583832290e-01f;		reg_M[13][8] = +1.648399769821804e+00f;		reg_M[13][9] = +1.206492505926940e-01f;		reg_M[13][10] = +1.295908896591411e+00f;		reg_M[14][1] = +2.591817793182820e-01f;		reg_M[14][2] = +6.254214424180560e-01f;		reg_M[14][3] = +2.591817793182820e-01f;		reg_M[14][4] = +6.254214424180560e-01f;		reg_M[14][5] = +2.591817793182820e-01f;		reg_M[14][6] = +6.254214424180560e-01f;		reg_M[14][7] = +2.133721389334470e-01f;		reg_M[14][8] = +5.183635586365640e-01f;		reg_M[14][9] = +1.647297885887280e-01f;		reg_M[14][10] = +4.029675624812460e-01f;		reg_M[15][1] = +1.928822529946110e-01f;		reg_M[15][2] = +1.967346701436834e+00f;		reg_M[15][3] = +1.928822529946110e-01f;		reg_M[15][4] = +1.967346701436834e+00f;		reg_M[15][5] = +1.928822529946110e-01f;		reg_M[15][6] = +1.967346701436834e+00f;		reg_M[15][7] = +1.928822529946110e-01f;		reg_M[15][8] = +1.967346701436834e+00f;		reg_M[15][9] = +1.575395583832290e-01f;		reg_M[15][10] = +1.648399769821804e+00f;		reg_M[16][1] = +2.591817793182820e-01f;		reg_M[16][2] = +6.254214424180560e-01f;		reg_M[16][3] = +2.591817793182820e-01f;		reg_M[16][4] = +6.254214424180560e-01f;		reg_M[16][5] = +2.591817793182820e-01f;		reg_M[16][6] = +6.254214424180560e-01f;		reg_M[16][7] = +2.591817793182820e-01f;		reg_M[16][8] = +6.254214424180560e-01f;		reg_M[16][9] = +2.133721389334470e-01f;		reg_M[16][10] = +5.183635586365640e-01f;		reg_M[17][1] = +1.928822529946110e-01f;		reg_M[17][2] = +1.967346701436834e+00f;		reg_M[17][3] = +1.928822529946110e-01f;		reg_M[17][4] = +1.967346701436834e+00f;		reg_M[17][5] = +1.928822529946110e-01f;		reg_M[17][6] = +1.967346701436834e+00f;		reg_M[17][7] = +1.928822529946110e-01f;		reg_M[17][8] = +1.967346701436834e+00f;		reg_M[17][9] = +1.928822529946110e-01f;		reg_M[17][10] = +1.967346701436834e+00f;		reg_M[18][1] = +2.591817793182820e-01f;		reg_M[18][2] = +6.254214424180560e-01f;		reg_M[18][3] = +2.591817793182820e-01f;		reg_M[18][4] = +6.254214424180560e-01f;		reg_M[18][5] = +2.591817793182820e-01f;		reg_M[18][6] = +6.254214424180560e-01f;		reg_M[18][7] = +2.591817793182820e-01f;		reg_M[18][8] = +6.254214424180560e-01f;		reg_M[18][9] = +2.591817793182820e-01f;		reg_M[18][10] = +6.254214424180560e-01f;		reg_M[19][1] = +1.928822529946110e-01f;		reg_M[19][2] = +1.967346701436834e+00f;		reg_M[19][3] = +1.928822529946110e-01f;		reg_M[19][4] = +1.967346701436834e+00f;		reg_M[19][5] = +1.928822529946110e-01f;		reg_M[19][6] = +1.967346701436834e+00f;		reg_M[19][7] = +1.928822529946110e-01f;		reg_M[19][8] = +1.967346701436834e+00f;		reg_M[19][9] = +1.928822529946110e-01f;		reg_M[19][10] = +1.967346701436834e+00f;		reg_M[20][1] = +2.591817793182820e-01f;		reg_M[20][2] = +6.254214424180560e-01f;		reg_M[20][3] = +2.591817793182820e-01f;		reg_M[20][4] = +6.254214424180560e-01f;		reg_M[20][5] = +2.591817793182820e-01f;		reg_M[20][6] = +6.254214424180560e-01f;		reg_M[20][7] = +2.591817793182820e-01f;		reg_M[20][8] = +6.254214424180560e-01f;		reg_M[20][9] = +2.591817793182820e-01f;		reg_M[20][10] = +6.254214424180560e-01f;
		reg_MP[1][1] = +4.019180586950399e-02f;
		reg_MP[1][2] = +4.305333247898890e-01f;
		reg_MP[1][3] = +3.850568904958701e-02f;
		reg_MP[1][4] = +3.895626619813200e-01f;
		reg_MP[1][5] = +3.689030779053500e-02f;
		reg_MP[1][6] = +3.524908732303931e-01f;
		reg_MP[1][7] = +3.534269461138201e-02f;
		reg_MP[1][8] = +3.189469316150300e-01f;
		reg_MP[2][1] = +5.484409686709099e-02f;
		reg_MP[2][2] = +1.340710198069900e-01f;
		reg_MP[2][3] = +5.165022530588601e-02f;
		reg_MP[2][4] = +1.243835153313620e-01f;
		reg_MP[2][5] = +4.864235034471900e-02f;
		reg_MP[2][6] = +1.153959961553180e-01f;
		reg_MP[2][7] = +4.580964038483501e-02f;
		reg_MP[2][8] = +1.070578837814920e-01f;
		reg_MP[3][1] = +7.869749491909100e-02f;
		reg_MP[3][2] = +8.200959867712090e-01f;
		reg_MP[3][3] = +7.539599684012201e-02f;
		reg_MP[3][4] = +7.420535352117130e-01f;
		reg_MP[3][5] = +7.223300240191700e-02f;
		reg_MP[3][6] = +6.714378048454230e-01f;
		reg_MP[3][7] = +3.534269461138201e-02f;
		reg_MP[3][8] = +3.189469316150300e-01f;
		reg_MP[4][1] = +1.064943221729770e-01f;
		reg_MP[4][2] = +2.584545351383520e-01f;
		reg_MP[4][3] = +1.002925756506050e-01f;
		reg_MP[4][4] = +2.397795114866800e-01f;
		reg_MP[4][5] = +9.445199072955401e-02f;
		reg_MP[4][6] = +2.224538799368100e-01f;
		reg_MP[4][7] = +4.580964038483501e-02f;
		reg_MP[4][8] = +1.070578837814920e-01f;
		reg_MP[5][1] = +1.155878027096260e-01f;
		reg_MP[5][2] = +1.172586860001602e+00f;
		reg_MP[5][3] = +1.107386914515040e-01f;
		reg_MP[5][4] = +1.061000466826743e+00f;
		reg_MP[5][5] = +7.223300240191700e-02f;
		reg_MP[5][6] = +6.714378048454230e-01f;
		reg_MP[5][7] = +3.534269461138201e-02f;
		reg_MP[5][8] = +3.189469316150300e-01f;
		reg_MP[6][1] = +1.551366725176960e-01f;
		reg_MP[6][2] = +3.738505312936700e-01f;
		reg_MP[6][3] = +1.461022160354400e-01f;
		reg_MP[6][4] = +3.468373952681720e-01f;
		reg_MP[6][5] = +9.445199072955401e-02f;
		reg_MP[6][6] = +2.224538799368100e-01f;
		reg_MP[6][7] = +4.580964038483501e-02f;
		reg_MP[6][8] = +1.070578837814920e-01f;
		reg_MP[7][1] = +1.509304973210080e-01f;
		reg_MP[7][2] = +1.491533791616632e+00f;
		reg_MP[7][3] = +1.107386914515040e-01f;
		reg_MP[7][4] = +1.061000466826743e+00f;
		reg_MP[7][5] = +7.223300240191700e-02f;
		reg_MP[7][6] = +6.714378048454230e-01f;
		reg_MP[7][7] = +3.534269461138201e-02f;
		reg_MP[7][8] = +3.189469316150300e-01f;
		reg_MP[8][1] = +2.009463129025310e-01f;
		reg_MP[8][2] = +4.809084150751620e-01f;
		reg_MP[8][3] = +1.461022160354400e-01f;
		reg_MP[8][4] = +3.468373952681720e-01f;
		reg_MP[8][5] = +9.445199072955401e-02f;
		reg_MP[8][6] = +2.224538799368100e-01f;
		reg_MP[8][7] = +4.580964038483501e-02f;
		reg_MP[8][8] = +1.070578837814920e-01f;
		reg_MP[9][1] = +1.509304973210080e-01f;
		reg_MP[9][2] = +1.491533791616632e+00f;
		reg_MP[9][3] = +1.107386914515040e-01f;
		reg_MP[9][4] = +1.061000466826743e+00f;
		reg_MP[9][5] = +7.223300240191700e-02f;
		reg_MP[9][6] = +6.714378048454230e-01f;
		reg_MP[9][7] = +3.534269461138201e-02f;
		reg_MP[9][8] = +3.189469316150300e-01f;
		reg_MP[10][1] = +2.009463129025310e-01f;
		reg_MP[10][2] = +4.809084150751620e-01f;
		reg_MP[10][3] = +1.461022160354400e-01f;
		reg_MP[10][4] = +3.468373952681720e-01f;
		reg_MP[10][5] = +9.445199072955401e-02f;
		reg_MP[10][6] = +2.224538799368100e-01f;
		reg_MP[10][7] = +4.580964038483501e-02f;
		reg_MP[10][8] = +1.070578837814920e-01f;
		reg_MP[11][1] = +1.509304973210080e-01f;
		reg_MP[11][2] = +1.491533791616632e+00f;
		reg_MP[11][3] = +1.107386914515040e-01f;
		reg_MP[11][4] = +1.061000466826743e+00f;
		reg_MP[11][5] = +7.223300240191700e-02f;
		reg_MP[11][6] = +6.714378048454230e-01f;
		reg_MP[11][7] = +3.534269461138201e-02f;
		reg_MP[11][8] = +3.189469316150300e-01f;
		reg_MP[12][1] = +2.009463129025310e-01f;
		reg_MP[12][2] = +4.809084150751620e-01f;
		reg_MP[12][3] = +1.461022160354400e-01f;
		reg_MP[12][4] = +3.468373952681720e-01f;
		reg_MP[12][5] = +9.445199072955401e-02f;
		reg_MP[12][6] = +2.224538799368100e-01f;
		reg_MP[12][7] = +4.580964038483501e-02f;
		reg_MP[12][8] = +1.070578837814920e-01f;
		reg_MP[13][1] = +1.509304973210080e-01f;
		reg_MP[13][2] = +1.491533791616632e+00f;
		reg_MP[13][3] = +1.107386914515040e-01f;
		reg_MP[13][4] = +1.061000466826743e+00f;
		reg_MP[13][5] = +7.223300240191700e-02f;
		reg_MP[13][6] = +6.714378048454230e-01f;
		reg_MP[13][7] = +3.534269461138201e-02f;
		reg_MP[13][8] = +3.189469316150300e-01f;
		reg_MP[14][1] = +2.009463129025310e-01f;
		reg_MP[14][2] = +4.809084150751620e-01f;
		reg_MP[14][3] = +1.461022160354400e-01f;
		reg_MP[14][4] = +3.468373952681720e-01f;
		reg_MP[14][5] = +9.445199072955401e-02f;
		reg_MP[14][6] = +2.224538799368100e-01f;
		reg_MP[14][7] = +4.580964038483501e-02f;
		reg_MP[14][8] = +1.070578837814920e-01f;
		reg_MP[15][1] = +1.509304973210080e-01f;
		reg_MP[15][2] = +1.491533791616632e+00f;
		reg_MP[15][3] = +1.107386914515040e-01f;
		reg_MP[15][4] = +1.061000466826743e+00f;
		reg_MP[15][5] = +7.223300240191700e-02f;
		reg_MP[15][6] = +6.714378048454230e-01f;
		reg_MP[15][7] = +3.534269461138201e-02f;
		reg_MP[15][8] = +3.189469316150300e-01f;
		reg_MP[16][1] = +2.009463129025310e-01f;
		reg_MP[16][2] = +4.809084150751620e-01f;
		reg_MP[16][3] = +1.461022160354400e-01f;
		reg_MP[16][4] = +3.468373952681720e-01f;
		reg_MP[16][5] = +9.445199072955401e-02f;
		reg_MP[16][6] = +2.224538799368100e-01f;
		reg_MP[16][7] = +4.580964038483501e-02f;
		reg_MP[16][8] = +1.070578837814920e-01f;
		reg_MP[17][1] = +1.509304973210080e-01f;
		reg_MP[17][2] = +1.491533791616632e+00f;
		reg_MP[17][3] = +1.107386914515040e-01f;
		reg_MP[17][4] = +1.061000466826743e+00f;
		reg_MP[17][5] = +7.223300240191700e-02f;
		reg_MP[17][6] = +6.714378048454230e-01f;
		reg_MP[17][7] = +3.534269461138201e-02f;
		reg_MP[17][8] = +3.189469316150300e-01f;
		reg_MP[18][1] = +2.009463129025310e-01f;
		reg_MP[18][2] = +4.809084150751620e-01f;
		reg_MP[18][3] = +1.461022160354400e-01f;
		reg_MP[18][4] = +3.468373952681720e-01f;
		reg_MP[18][5] = +9.445199072955401e-02f;
		reg_MP[18][6] = +2.224538799368100e-01f;
		reg_MP[18][7] = +4.580964038483501e-02f;
		reg_MP[18][8] = +1.070578837814920e-01f;
		reg_MP[19][1] = +1.509304973210080e-01f;
		reg_MP[19][2] = +1.491533791616632e+00f;
		reg_MP[19][3] = +1.107386914515040e-01f;
		reg_MP[19][4] = +1.061000466826743e+00f;
		reg_MP[19][5] = +7.223300240191700e-02f;
		reg_MP[19][6] = +6.714378048454230e-01f;
		reg_MP[19][7] = +3.534269461138201e-02f;
		reg_MP[19][8] = +3.189469316150300e-01f;
		reg_MP[20][1] = +2.009463129025310e-01f;
		reg_MP[20][2] = +4.809084150751620e-01f;
		reg_MP[20][3] = +1.461022160354400e-01f;
		reg_MP[20][4] = +3.468373952681720e-01f;
		reg_MP[20][5] = +9.445199072955401e-02f;
		reg_MP[20][6] = +2.224538799368100e-01f;
		reg_MP[20][7] = +4.580964038483501e-02f;
		reg_MP[20][8] = +1.070578837814920e-01f;

		for(i=1;i<=20;++i)
			for(j=1;j<=20;++j)
				reg_PSI[i][j] = 0.0f;
		reg_PSI[1][1] = +1.000000000000000e+00f;
		reg_PSI[2][2] = +2.000000000000000e+00f;
		reg_PSI[3][3] = +1.000000000000000e+00f;
		reg_PSI[4][4] = +2.000000000000000e+00f;
		reg_PSI[5][5] = +1.000000000000000e+00f;
		reg_PSI[6][6] = +2.000000000000000e+00f;
		reg_PSI[7][7] = +1.000000000000000e+00f;
		reg_PSI[8][8] = +2.000000000000000e+00f;
		reg_PSI[9][9] = +1.000000000000000e+00f;
		reg_PSI[10][10] = +2.000000000000000e+00f;
		reg_PSI[11][11] = +1.000000000000000e+00f;
		reg_PSI[12][12] = +2.000000000000000e+00f;
		reg_PSI[13][13] = +1.000000000000000e+00f;
		reg_PSI[14][14] = +2.000000000000000e+00f;
		reg_PSI[15][15] = +1.000000000000000e+00f;
		reg_PSI[16][16] = +2.000000000000000e+00f;
		reg_PSI[17][17] = +1.000000000000000e+00f;
		reg_PSI[18][18] = +2.000000000000000e+00f;
		reg_PSI[19][19] = +1.000000000000000e+00f;
		reg_PSI[20][20] = +2.000000000000000e+00f;

		for(i=1;i<=10;++i)
			for(j=1;j<=10;++j)
				reg_LAMBDA[i][j] = 0.0f;
		reg_LAMBDA[1][1] = +7.500000000000000e-02f;
		reg_LAMBDA[2][2] = +1.500000000000000e-01f;
		reg_LAMBDA[3][3] = +7.500000000000000e-02f;
		reg_LAMBDA[4][4] = +1.500000000000000e-01f;
		reg_LAMBDA[5][5] = +7.500000000000000e-02f;
		reg_LAMBDA[6][6] = +1.500000000000000e-01f;
		reg_LAMBDA[7][7] = +7.500000000000000e-02f;
		reg_LAMBDA[8][8] = +1.500000000000000e-01f;
		reg_LAMBDA[9][9] = +7.500000000000000e-02f;
		reg_LAMBDA[10][10] = +1.500000000000000e-01f;

		ustawilogr(20);
		ustawilzm(10);

		inicjalizacjapk();
		pk_A=pobierzA();
		pk_G=pobierzG();
		pk_b=pobierzb();
		pk_t=pobierzt();
		pk_x=pobierzx();

		for(i=1;i<=20;++i)
			for(j=1;j<=10;++j)
				pk_A[i][j] = 0.0f;
		pk_A[1][1] = +1.000000000000000e+00f;
		pk_A[2][1] = -1.000000000000000e+00f;
		pk_A[3][2] = +1.000000000000000e+00f;
		pk_A[4][2] = -1.000000000000000e+00f;
		pk_A[5][1] = +1.000000000000000e+00f;
		pk_A[5][3] = +1.000000000000000e+00f;
		pk_A[6][1] = -1.000000000000000e+00f;
		pk_A[6][3] = -1.000000000000000e+00f;
		pk_A[7][2] = +1.000000000000000e+00f;
		pk_A[7][4] = +1.000000000000000e+00f;
		pk_A[8][2] = -1.000000000000000e+00f;
		pk_A[8][4] = -1.000000000000000e+00f;
		pk_A[9][1] = +1.000000000000000e+00f;
		pk_A[9][3] = +1.000000000000000e+00f;
		pk_A[9][5] = +1.000000000000000e+00f;
		pk_A[10][1] = -1.000000000000000e+00f;
		pk_A[10][3] = -1.000000000000000e+00f;
		pk_A[10][5] = -1.000000000000000e+00f;
		pk_A[11][2] = +1.000000000000000e+00f;
		pk_A[11][4] = +1.000000000000000e+00f;
		pk_A[11][6] = +1.000000000000000e+00f;
		pk_A[12][2] = -1.000000000000000e+00f;
		pk_A[12][4] = -1.000000000000000e+00f;
		pk_A[12][6] = -1.000000000000000e+00f;
		pk_A[13][1] = +1.000000000000000e+00f;
		pk_A[13][3] = +1.000000000000000e+00f;
		pk_A[13][5] = +1.000000000000000e+00f;
		pk_A[13][7] = +1.000000000000000e+00f;
		pk_A[14][1] = -1.000000000000000e+00f;
		pk_A[14][3] = -1.000000000000000e+00f;
		pk_A[14][5] = -1.000000000000000e+00f;
		pk_A[14][7] = -1.000000000000000e+00f;
		pk_A[15][2] = +1.000000000000000e+00f;
		pk_A[15][4] = +1.000000000000000e+00f;
		pk_A[15][6] = +1.000000000000000e+00f;
		pk_A[15][8] = +1.000000000000000e+00f;
		pk_A[16][2] = -1.000000000000000e+00f;
		pk_A[16][4] = -1.000000000000000e+00f;
		pk_A[16][6] = -1.000000000000000e+00f;
		pk_A[16][8] = -1.000000000000000e+00f;
		pk_A[17][1] = +1.000000000000000e+00f;
		pk_A[17][3] = +1.000000000000000e+00f;
		pk_A[17][5] = +1.000000000000000e+00f;
		pk_A[17][7] = +1.000000000000000e+00f;
		pk_A[17][9] = +1.000000000000000e+00f;
		pk_A[18][1] = -1.000000000000000e+00f;
		pk_A[18][3] = -1.000000000000000e+00f;
		pk_A[18][5] = -1.000000000000000e+00f;
		pk_A[18][7] = -1.000000000000000e+00f;
		pk_A[18][9] = -1.000000000000000e+00f;
		pk_A[19][2] = +1.000000000000000e+00f;
		pk_A[19][4] = +1.000000000000000e+00f;
		pk_A[19][6] = +1.000000000000000e+00f;
		pk_A[19][8] = +1.000000000000000e+00f;
		pk_A[19][10] = +1.000000000000000e+00f;
		pk_A[20][2] = -1.000000000000000e+00f;
		pk_A[20][4] = -1.000000000000000e+00f;
		pk_A[20][6] = -1.000000000000000e+00f;
		pk_A[20][8] = -1.000000000000000e+00f;
		pk_A[20][10] = -1.000000000000000e+00f;

		for(i=1;i<=20;++i)
			pk_b[i] = 0.0f;

		pk_G[1][1] = +2.659780093449670e+00f;
		pk_G[1][2] = +1.033245618633255e+01f;
		pk_G[1][3] = +2.303694937078161e+00f;
		pk_G[1][4] = +9.507957368416482e+00f;
		pk_G[1][5] = +2.042624707692072e+00f;
		pk_G[1][6] = +8.453648736194179e+00f;
		pk_G[1][7] = +1.740469754062256e+00f;
		pk_G[1][8] = +7.224661197767065e+00f;
		pk_G[1][9] = +1.410998207374301e+00f;
		pk_G[1][10] = +5.877450680280752e+00f;
		pk_G[2][1] = +1.033245618633255e+01f;
		pk_G[2][2] = +6.914031712916767e+01f;
		pk_G[2][3] = +9.465705711134994e+00f;
		pk_G[2][4] = +6.323985134939012e+01f;
		pk_G[2][5] = +8.377650950697033e+00f;
		pk_G[2][6] = +5.614371861669098e+01f;
		pk_G[2][7] = +7.127605942633382e+00f;
		pk_G[2][8] = +4.793780009717338e+01f;
		pk_G[2][9] = +5.771981075843117e+00f;
		pk_G[2][10] = +3.899768925808417e+01f;
		pk_G[3][1] = +2.303694937078161e+00f;
		pk_G[3][2] = +9.465705711134994e+00f;
		pk_G[3][3] = +2.316672187486753e+00f;
		pk_G[3][4] = +8.925132288864370e+00f;
		pk_G[3][5] = +1.960587031115244e+00f;
		pk_G[3][6] = +8.100633470948305e+00f;
		pk_G[3][7] = +1.699516801729155e+00f;
		pk_G[3][8] = +7.046324838726001e+00f;
		pk_G[3][9] = +1.397361848099339e+00f;
		pk_G[3][10] = +5.817337300298888e+00f;
		pk_G[4][1] = +9.507957368416482e+00f;
		pk_G[4][2] = +6.323985134939012e+01f;
		pk_G[4][3] = +8.925132288864370e+00f;
		pk_G[4][4] = +5.983480311931377e+01f;
		pk_G[4][5] = +8.058381813666816e+00f;
		pk_G[4][6] = +5.393433733953621e+01f;
		pk_G[4][7] = +6.970327053228854e+00f;
		pk_G[4][8] = +4.683820460683707e+01f;
		pk_G[4][9] = +5.720282045165204e+00f;
		pk_G[4][10] = +3.863228608731947e+01f;
		pk_G[5][1] = +2.042624707692072e+00f;
		pk_G[5][2] = +8.377650950697033e+00f;
		pk_G[5][3] = +1.960587031115244e+00f;
		pk_G[5][4] = +8.058381813666816e+00f;
		pk_G[5][5] = +1.973564281523836e+00f;
		pk_G[5][6] = +7.517808391396192e+00f;
		pk_G[5][7] = +1.617479125152327e+00f;
		pk_G[5][8] = +6.693309573480126e+00f;
		pk_G[5][9] = +1.356408895766239e+00f;
		pk_G[5][10] = +5.639000941257823e+00f;
		pk_G[6][1] = +8.453648736194179e+00f;
		pk_G[6][2] = +5.614371861669098e+01f;
		pk_G[6][3] = +8.100633470948305e+00f;
		pk_G[6][4] = +5.393433733953621e+01f;
		pk_G[6][5] = +7.517808391396192e+00f;
		pk_G[6][6] = +5.052928910945986e+01f;
		pk_G[6][7] = +6.651057916198639e+00f;
		pk_G[6][8] = +4.462882332968231e+01f;
		pk_G[6][9] = +5.563003155760677e+00f;
		pk_G[6][10] = +3.753269059698317e+01f;
		pk_G[7][1] = +1.740469754062256e+00f;
		pk_G[7][2] = +7.127605942633382e+00f;
		pk_G[7][3] = +1.699516801729155e+00f;
		pk_G[7][4] = +6.970327053228854e+00f;
		pk_G[7][5] = +1.617479125152327e+00f;
		pk_G[7][6] = +6.651057916198639e+00f;
		pk_G[7][7] = +1.630456375560919e+00f;
		pk_G[7][8] = +6.110484493928015e+00f;
		pk_G[7][9] = +1.274371219189410e+00f;
		pk_G[7][10] = +5.285985676011949e+00f;
		pk_G[8][1] = +7.224661197767065e+00f;
		pk_G[8][2] = +4.793780009717338e+01f;
		pk_G[8][3] = +7.046324838726001e+00f;
		pk_G[8][4] = +4.683820460683707e+01f;
		pk_G[8][5] = +6.693309573480126e+00f;
		pk_G[8][6] = +4.462882332968231e+01f;
		pk_G[8][7] = +6.110484493928015e+00f;
		pk_G[8][8] = +4.122377509960595e+01f;
		pk_G[8][9] = +5.243734018730461e+00f;
		pk_G[8][10] = +3.532330931982840e+01f;
		pk_G[9][1] = +1.410998207374301e+00f;
		pk_G[9][2] = +5.771981075843117e+00f;
		pk_G[9][3] = +1.397361848099339e+00f;
		pk_G[9][4] = +5.720282045165204e+00f;
		pk_G[9][5] = +1.356408895766239e+00f;
		pk_G[9][6] = +5.563003155760677e+00f;
		pk_G[9][7] = +1.274371219189410e+00f;
		pk_G[9][8] = +5.243734018730461e+00f;
		pk_G[9][9] = +1.287348469598002e+00f;
		pk_G[9][10] = +4.703160596459838e+00f;
		pk_G[10][1] = +5.877450680280752e+00f;
		pk_G[10][2] = +3.899768925808417e+01f;
		pk_G[10][3] = +5.817337300298888e+00f;
		pk_G[10][4] = +3.863228608731947e+01f;
		pk_G[10][5] = +5.639000941257823e+00f;
		pk_G[10][6] = +3.753269059698317e+01f;
		pk_G[10][7] = +5.285985676011949e+00f;
		pk_G[10][8] = +3.532330931982840e+01f;
		pk_G[10][9] = +4.703160596459838e+00f;
		pk_G[10][10] = +3.191826108975205e+01f;

		reg_DUP =dwektor(1,8);
		reg_Yk  =dwektor(1,20);
		reg_Yzad=dwektor(1,20);
		reg_Y0  =dwektor(1,20);
		reg_wp1 =dwektor(1,20);
		reg_mp1 =dtablica(1,10,1,20);
		return;
	}
	i=0;
	for(p=0;p<4;++p){
		for(n=0;n<2;++n){
			reg_DUP[i+1] = ad->u[k-p-1][n]-ad->u[k-p-2][n];
			++i;
		}
	}

	iloczynaw(reg_MP,reg_DUP,reg_wp1,20,8,8);
	sumaww(reg_Yk,reg_wp1,reg_Y0,20,1);

	l=1;
	for(p=1;p<=10;p++){
		for(m=0;m<2;m++){
			reg_Yzad[l++] = ad->z[m];
		}
	}

	i=1;
	for(p=0;p<=4;p++){
		for(n=1;n<=2;n++){
			pk_b[i++]=-1.000000000000000e+00f-ad->u[k-1][n-1];
			pk_b[i++]=-1.000000000000000e+00f+ad->u[k-1][n-1];
		}
	}

	for(i=1;i<=10;i++) pk_x[i]=0.0f;
	sumaww(reg_Yzad,reg_Y0,reg_wp1,20,-1);
	iloczynatb(reg_M,reg_PSI,reg_mp1,20,10,20,20);
	iloczynaw(reg_mp1,reg_wp1,pk_t,10,20,20);
	for(i=1;i<=10;i++) pk_t[i]=-2.0f*pk_t[i];

	i=pk();
	write_string("\e[31m%%-A-G-b-t-x---min 0.5x'*G*x+t'*x, Ax>=b----------\n\r");
	write_string("\e[32mA=");printMat(pk_A,20,10,"%2.0f");
	write_string("\e[33mG=");printMat(pk_G,10,10,"%8.4f");
	write_string("\e[34mb=");printVec(pk_b,20,"%8.4f");
	write_string("\e[35mt=");printVec(pk_t,10,"%8.4f");
	write_string("\e[36mx=");printVec(pk_x,10,"%8.4f");

	for(n=1;n<=2;n++) du[n-1]=pk_x[n];

	setCurrentControlIncrement(c,du);
}

//////////////////////////////////////////////////// TUTAJ ZACZYNA SIE ROBOTA UZYTKOWNIKA KONCOWEGO
ArchiveData ad;
CurrentControl cc;

void measurements(){
    new_output(&ad,measureOutput());
}

void controller_setup(){
    init_archive_data(&ad, 100, 100, 2, 2, 0, 0, 0.01);
    init_current_control(&cc,&ad);
    get_time();
    CONTROLLER(NULL,NULL);
    CONTROLLER_N(NULL,NULL);
}

void idle(){
    const int k = 0;
    // Komunikacja z komputerem zbierającym dane 
    sprintf(str, "y=[%8.4f,%8.4f];\n\r", ad.y[k][0],ad.y[k][1]);
    write_string(str);
    sprintf(str, "z=[%8.4f,%8.4f];\n\r", ad.z[0],ad.z[1]);
    write_string(str);
    sprintf(str, "u=[%8.4f,%8.4f];\n\r", ad.u[k-1][0],ad.u[k-1][1]);
    write_string(str);
}

void loop(){
    static int i = 0;
    if(i<50){ ad.z[0] =  0.1;}
    else    { ad.z[0] = -0.1;}
    if(++i >= 100) i = 0;
    CONTROLLER_N(&ad,&cc);

    // static float du[1] = {0};
    // if(i++<500) du[0] = 0.0f;
    // else      du[0] = 1.0f;
    // setCurrentControl(&cc,du);
    // string_spin();
}

void controls(){
    pushCurrentControlsToArchiveData(&cc,&ad);
    //projectOnFeasibleSet(&ad, NAN, NAN, 0.0, 1.0);
    setControlValue(last_control(&ad));
}

void timeout(){
    //setControlValue(0.0);
    // while(1);
}
